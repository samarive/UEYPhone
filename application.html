<!DOCTYPE html>
<head>
	<meta charset='utf-8'/>
	<title>UEY Phone</title>
	<script type='text/javascript'>
		application_state = {
			current_pane: 'login',
			username: 'username',
			password: 'password',
			current_number: 'none',
			token: 'none'
		};
		
		function switch_pane(target_pane) {
			const p = document.getElementById(target_pane);
			if (p == null) {
				console.log("No such pane in application :");
				console.log(target_pane);
				return;
			}
			document.getElementById(application_state.current_pane).style = "visibility: hidden;";
			p.style = "visibility: shown;";
			application_state.current_pane = target_pane;
		}
		
		async function attempt_connection() {
			application_state.username = document.getElementById("username").value;
			application_state.password = document.getElementById("password").value;

			const login_trial = await fetch("http://localhost:8000/connect(" + application_state.username + "," + application_state.password+ ")");

			if (login_trial.status == 401) {
				document.getElementById("wrong_cred").style = "visibility: shown;color: red;";
			}

			if (login_trial.status == 200) {

				application_state.token = login_trial.statusText;
				
				return true;
			} else {
				return false;
			}
		}

		async function get_call_info() {
			const info = await fetch("http://localhost:8000/get_call_info(" + application_state.token + ")");
			if (info.statusText == "All clear") {
				switch_pane("congrats");
			} else if (info.status == 200) {
				let state = 0;
				let buffer = "";
				for (c of info.statusText) {
					if (c == ',') {
						if (state == 0) {
							document.getElementById("name").innerText = "Prénom : " + buffer;
						} else if (state == 1) {
							document.getElementById("surname").innerText = "Nom : " + buffer;
						} else if (state == 2) {
							document.getElementById("number").innerText = "Numéro : " + buffer;
							application_state.current_number = buffer;
						}
						buffer = "";
						state += 1;
						if (state == 3) {break;}
					} else {
						buffer += c;
					}
				}
			} else {
				switch_pane('login');
				application_state.username = 'username';
				application_state.password = 'password';
				application_state.current_number = 'none';
				application_state.token = 'none';
			}
		}

		async function login() {
			if (await attempt_connection()) {
				switch_pane('application');
				get_call_info();
			}
		}

		async function call_later() {
			await fetch("http://localhost:8000/call_later(" + application_state.current_number + "," +
				application_state.token + ")");
			get_call_info();
		}

	</script>
	<noscript>
		Veuillez utiliser un navigateur qui supporte le JavaScript (btw on est en 2024, il s'agirait de se mettre à jour).
	</noscript>
</head>

<body>
	<h1>UEY Phone</h1>
	<div id='login'>
		<input id='username' placeholder="Nom d'utilisateur"/>
		<input id='password' type='password' placeholder='Mot de passe'/>
		<button id='login' onclick="login()">
			Se connecter
		</button>
		<p id="wrong_cred" style="visibility: hidden;">Identifiant ou mot de passe incorrecte</p>
	</div>
	<div id='congrats' style="visibility: hidden;">
		<h1>Tous les numéros ont été appelés !</h1>
	</div>
	<div id='application' style='visibility: hidden;'>
		<div id='infos'>
			<p id='name'>Prénom: Jean</p>
			<p id='surname'>Nom: Dupont</p>
			<p id='number'>Tél: 06 00 00 00 00</p>
		</div>

		<div id='actions'>
			<button id='responded' onclick="get_call_info()">A répondu</button>
			<button id='no answer' onclick="call_later()">N'a pas répondu</button>
			<button id='do not call'>Ne souhaite plus être appelé</button>
		</div>
	</div>

</body>